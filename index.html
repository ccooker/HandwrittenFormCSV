<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Printing Log Scanner</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .drag-active {
            border-color: #4f46e5;
            background-color: #eef2ff;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #c7c7c7; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1; 
        }
        
        /* Table cell padding fix */
        td, th {
            white-space: nowrap;
        }
    </style>
</head>
<body class="text-gray-800 h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 shadow-sm z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 text-white p-2 rounded-lg">
                    <i class="fa-solid fa-print"></i>
                </div>
                <h1 class="text-xl font-bold text-gray-900 tracking-tight">Printing<span class="text-indigo-600">Log</span>Scanner <span class="text-xs bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded ml-2">AI Powered</span></h1>
            </div>
            <div class="flex gap-2">
                <button onclick="app.exportCSV()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors flex items-center gap-2 shadow-sm">
                    <i class="fa-solid fa-file-csv"></i> Export Log
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col lg:flex-row overflow-hidden relative">
        
        <!-- Left Panel: Input & Review -->
        <div class="flex-1 flex flex-col border-r border-gray-200 bg-white overflow-y-auto p-6 min-w-[400px]">
            
            <!-- Upload Section -->
            <div id="upload-zone" class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center cursor-pointer transition-all duration-200 hover:border-indigo-400 hover:bg-gray-50 mb-6 group">
                <input type="file" id="file-input" class="hidden" accept="image/*" multiple>
                <div class="flex flex-col items-center justify-center gap-3">
                    <div class="w-16 h-16 bg-indigo-50 text-indigo-600 rounded-full flex items-center justify-center text-2xl group-hover:scale-110 transition-transform">
                        <i class="fa-solid fa-cloud-arrow-up"></i>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900">Upload Log Images</h3>
                    <p class="text-sm text-gray-500 max-w-xs">Drag & drop multiple files here to batch process.</p>
                </div>
            </div>

            <!-- Progress Bar -->
            <div id="progress-container" class="hidden mb-6">
                <div class="flex justify-between mb-1">
                    <span class="text-sm font-medium text-indigo-600" id="progress-status">Scanning text...</span>
                    <span class="text-sm font-medium text-indigo-600" id="progress-percent"></span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5 overflow-hidden">
                    <div id="progress-bar" class="bg-indigo-600 h-2.5 rounded-full transition-all duration-1000 w-full animate-pulse"></div>
                </div>
            </div>

            <!-- Review Section -->
            <div id="review-section" class="hidden flex-1 flex flex-col gap-6">
                
                <!-- Image Preview -->
                <div class="bg-gray-100 rounded-lg border border-gray-200 p-2 flex items-center justify-center min-h-[150px] max-h-[250px] relative group">
                    <img id="preview-image" src="" alt="Preview" class="h-full object-contain rounded shadow-sm">
                    
                    <!-- Queue Count Overlay -->
                    <div id="queue-badge" class="absolute top-2 left-2 bg-black/75 text-white text-xs px-2 py-1 rounded-full backdrop-blur-sm hidden">
                        Queue: 0
                    </div>

                    <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="app.skipCurrent()" class="bg-white text-red-500 p-2 rounded shadow hover:bg-red-50" title="Skip this image">
                            <i class="fa-solid fa-forward"></i> Skip
                        </button>
                    </div>
                </div>

                <!-- Extraction Form -->
                <div id="extraction-form" class="bg-white rounded-xl border border-gray-200 shadow-sm p-5 flex flex-col gap-4 flex-1 transition-colors duration-300">
                    <div class="flex items-center justify-between border-b pb-3 border-gray-200/50">
                        <h3 class="font-semibold text-gray-800" id="form-title">Log Entry Details</h3>
                        <span class="text-xs bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full">AI Extraction</span>
                    </div>

                    <!-- OCR Scratchpad -->
                    <div class="mb-2">
                        <label class="block text-xs font-medium text-gray-500 mb-1 uppercase tracking-wider">AI Response (Debug)</label>
                        <textarea id="field-ocr-raw" class="w-full h-20 border border-gray-200 rounded-md px-3 py-2 text-xs text-gray-600 bg-white/50 focus:ring-2 focus:ring-indigo-500 outline-none resize-none font-mono" readonly placeholder="AI extracted data will appear here..."></textarea>
                    </div>

                    <!-- Data Fields -->
                    <div class="space-y-3">
                        <!-- Row 1 -->
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Date</label>
                                <input type="date" id="field-date" class="w-full border border-gray-300 rounded-md px-3 py-1.5 text-sm focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Class</label>
                                <input type="text" id="field-class" class="w-full border border-gray-300 rounded-md px-3 py-1.5 text-sm focus:ring-indigo-500 focus:border-indigo-500 bg-white" placeholder="e.g. 5A">
                            </div>
                        </div>

                        <!-- Row 2 -->
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Subject</label>
                                <input type="text" id="field-subject" class="w-full border border-gray-300 rounded-md px-3 py-1.5 text-sm focus:ring-indigo-500 focus:border-indigo-500 bg-white" placeholder="e.g. Math">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Teacher-in-charge</label>
                                <input type="text" id="field-teacher" class="w-full border border-gray-300 rounded-md px-3 py-1.5 text-sm focus:ring-indigo-500 focus:border-indigo-500 bg-white" placeholder="Name">
                            </div>
                        </div>

                        <!-- Row 3: Counts -->
                        <div class="grid grid-cols-3 gap-3 bg-gray-50/50 p-3 rounded-lg border border-gray-200">
                            <div>
                                <label class="block text-[10px] font-bold text-gray-500 mb-1 uppercase">Originals</label>
                                <input type="number" id="field-originals" min="1" class="w-full border border-gray-300 rounded-md px-2 py-1.5 text-sm bg-white" oninput="app.calcTotal()">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-gray-500 mb-1 uppercase">Copies</label>
                                <input type="number" id="field-copies" min="1" class="w-full border border-gray-300 rounded-md px-2 py-1.5 text-sm bg-white" oninput="app.calcTotal()">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-gray-500 mb-1 uppercase">Total Pages</label>
                                <input type="number" id="field-total" readonly class="w-full border border-gray-200 bg-gray-100 rounded-md px-2 py-1.5 text-sm font-bold text-indigo-600">
                            </div>
                        </div>

                        <!-- Row 4: Printers -->
                        <div class="grid grid-cols-2 gap-3">
                            <div class="relative">
                                <label class="block text-xs font-medium text-gray-700 mb-1">Ricoh (Count)</label>
                                <input type="number" id="field-ricoh" class="w-full border border-gray-300 rounded-md px-3 py-1.5 text-sm focus:ring-indigo-500 focus:border-indigo-500 bg-white" placeholder="0">
                            </div>
                            <div class="relative">
                                <label class="block text-xs font-medium text-gray-700 mb-1">Toshiba (Count)</label>
                                <input type="number" id="field-toshiba" class="w-full border border-gray-300 rounded-md px-3 py-1.5 text-sm focus:ring-indigo-500 focus:border-indigo-500 bg-white" placeholder="0">
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-2 mt-2">
                        <button onclick="app.addToSheet()" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-lg font-medium shadow-md hover:shadow-lg transition-all flex justify-center items-center gap-2">
                            <i class="fa-solid fa-check"></i> <span id="btn-add-text">Add Entry</span>
                        </button>
                    </div>
                </div>
            </div>

        </div>

        <!-- Right Panel: Spreadsheet View -->
        <div class="flex-1 bg-gray-50 flex flex-col overflow-hidden relative">
            <div class="p-4 border-b border-gray-200 bg-white flex justify-between items-center">
                <h2 class="font-semibold text-gray-700 flex items-center gap-2">
                    <i class="fa-solid fa-table text-gray-400"></i> Printing Log Data
                </h2>
                <span id="row-count" class="text-xs font-medium bg-gray-100 text-gray-600 px-2 py-1 rounded">0 Rows</span>
            </div>

            <div class="flex-1 overflow-auto p-4">
                <div class="bg-white rounded-lg shadow border border-gray-200 overflow-auto min-h-[200px]">
                    <table class="w-full text-left border-collapse min-w-[800px]">
                        <thead class="bg-gray-50 text-xs uppercase text-gray-500 font-medium sticky top-0 z-10 shadow-sm">
                            <tr>
                                <th class="px-4 py-3 border-b bg-gray-50">Date</th>
                                <th class="px-4 py-3 border-b bg-gray-50">Class</th>
                                <th class="px-4 py-3 border-b bg-gray-50">Subject</th>
                                <th class="px-4 py-3 border-b bg-gray-50">Teacher</th>
                                <th class="px-4 py-3 border-b bg-gray-50 text-right">Orig.</th>
                                <th class="px-4 py-3 border-b bg-gray-50 text-right">Copies</th>
                                <th class="px-4 py-3 border-b bg-gray-50 text-right text-indigo-600">Total</th>
                                <th class="px-4 py-3 border-b bg-gray-50 text-right">Ricoh</th>
                                <th class="px-4 py-3 border-b bg-gray-50 text-right">Toshiba</th>
                                <th class="px-4 py-3 border-b bg-gray-50 text-center sticky right-0 bg-gray-50">Act</th>
                            </tr>
                        </thead>
                        <tbody id="data-table-body" class="text-sm divide-y divide-gray-100">
                            <!-- Rows will be injected here -->
                            <tr id="empty-state">
                                <td colspan="10" class="px-4 py-12 text-center text-gray-400 italic">
                                    <div class="flex flex-col items-center gap-2">
                                        <i class="fa-solid fa-print text-3xl mb-2 text-gray-300"></i>
                                        No logs added yet.<br>Upload an image to extract data.
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <!-- Scripts -->
    <script>
        const app = {
            data: [],
            // TODO: PASTE YOUR API KEY HERE FOR DEPLOYMENT (e.g. "AIzaSy...")
            apiKey: "AIzaSyBFja2zk0tLF4_b8lokAUFA5jrqbYc2678", 
            
            // Queue Management
            queue: [],
            totalInBatch: 0,
            processedInBatch: 0,
            
            init() {
                console.log("App initialized");
                this.cacheDOM();
                this.bindEvents();
                this.dom.fieldDate.valueAsDate = new Date();
            },

            cacheDOM() {
                this.dom = {
                    uploadZone: document.getElementById('upload-zone'),
                    fileInput: document.getElementById('file-input'),
                    progressContainer: document.getElementById('progress-container'),
                    progressBar: document.getElementById('progress-bar'),
                    progressStatus: document.getElementById('progress-status'),
                    progressPercent: document.getElementById('progress-percent'),
                    reviewSection: document.getElementById('review-section'),
                    extractionForm: document.getElementById('extraction-form'),
                    previewImage: document.getElementById('preview-image'),
                    queueBadge: document.getElementById('queue-badge'),
                    formTitle: document.getElementById('form-title'),
                    btnAddText: document.getElementById('btn-add-text'),
                    
                    // Inputs
                    ocrRaw: document.getElementById('field-ocr-raw'),
                    fieldDate: document.getElementById('field-date'),
                    fieldClass: document.getElementById('field-class'),
                    fieldSubject: document.getElementById('field-subject'),
                    fieldTeacher: document.getElementById('field-teacher'),
                    fieldOriginals: document.getElementById('field-originals'),
                    fieldCopies: document.getElementById('field-copies'),
                    fieldTotal: document.getElementById('field-total'),
                    fieldRicoh: document.getElementById('field-ricoh'),
                    fieldToshiba: document.getElementById('field-toshiba'),
                    
                    tableBody: document.getElementById('data-table-body'),
                    rowCount: document.getElementById('row-count'),
                    emptyState: document.getElementById('empty-state')
                };
            },

            bindEvents() {
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    this.dom.uploadZone.addEventListener(eventName, this.preventDefaults, false);
                });
                ['dragenter', 'dragover'].forEach(eventName => this.dom.uploadZone.classList.add('drag-active'));
                ['dragleave', 'drop'].forEach(eventName => this.dom.uploadZone.classList.remove('drag-active'));

                this.dom.uploadZone.addEventListener('drop', this.handleDrop.bind(this), false);
                this.dom.uploadZone.addEventListener('click', (e) => {
                    // Prevent triggering click when clicking child elements if needed
                    this.dom.fileInput.click(); 
                });
                this.dom.fileInput.addEventListener('change', this.handleFileSelect.bind(this));
            },

            preventDefaults(e) { e.preventDefault(); e.stopPropagation(); },

            handleDrop(e) {
                console.log("File dropped");
                const dt = e.dataTransfer;
                const files = dt.files;
                this.handleFiles(files);
            },

            handleFileSelect(e) {
                console.log("File selected");
                const files = e.target.files;
                this.handleFiles(files);
            },

            handleFiles(files) {
                const imageFiles = Array.from(files).filter(file => file.type.startsWith('image/'));
                console.log(`Found ${imageFiles.length} image files`);
                
                if (imageFiles.length > 0) {
                    // Add to queue
                    this.queue.push(...imageFiles);
                    
                    // If we are starting a new batch
                    if (this.dom.reviewSection.classList.contains('hidden')) {
                        this.totalInBatch = this.queue.length;
                        this.processedInBatch = 0;
                        this.processNextInQueue();
                    } else {
                        // If adding to existing batch
                        this.totalInBatch += imageFiles.length;
                        this.updateQueueUI();
                    }
                } else {
                    alert("Please upload image files.");
                }
            },

            processNextInQueue() {
                if (this.queue.length === 0) {
                    this.returnToUpload();
                    return;
                }

                const file = this.queue.shift();
                this.processedInBatch++;
                this.updateQueueUI();
                this.previewAndProcess(file);
            },

            updateQueueUI() {
                const remaining = this.queue.length;
                
                if (remaining > 0) {
                    this.dom.queueBadge.innerText = `Queue: ${remaining}`;
                    this.dom.queueBadge.classList.remove('hidden');
                    this.dom.btnAddText.innerText = "Add & Next";
                } else {
                    this.dom.queueBadge.classList.add('hidden');
                    this.dom.btnAddText.innerText = "Add Entry";
                }

                this.dom.formTitle.innerText = `Log Entry Details (${this.processedInBatch} of ${this.totalInBatch})`;
            },

            previewAndProcess(file) {
                console.log("Previewing file:", file.name);
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.dom.previewImage.src = e.target.result;
                    this.dom.reviewSection.classList.remove('hidden');
                    this.dom.uploadZone.classList.add('hidden');
                    
                    // Convert file to base64 without prefix for API
                    const base64Data = e.target.result.split(',')[1];
                    const mimeType = file.type;
                    
                    this.processImageWithGemini(base64Data, mimeType);
                };
                reader.readAsDataURL(file);
            },

            async processImageWithGemini(base64Data, mimeType) {
                console.log("Starting AI Process...");

                // --- CRITICAL: API KEY CHECK ---
                if(!this.apiKey) {
                     const userKey = prompt("No API Key found in code. Please enter your Google Gemini API Key:");
                     if(userKey && userKey.trim() !== "") {
                         this.apiKey = userKey.trim();
                     } else {
                         alert("API Key required for AI processing. Returning to upload.");
                         this.returnToUpload();
                         return;
                     }
                }

                this.dom.progressContainer.classList.remove('hidden');
                this.dom.progressStatus.innerText = `Scanning image ${this.processedInBatch} of ${this.totalInBatch}...`;
                this.dom.ocrRaw.value = "Sending to AI...";
                
                // Disable fields while scanning
                this.toggleFields(true);

                // Updated Prompt for Circled items
                const promptText = `
                    You are an expert in data extraction from handwritten documents, with a meticulous eye for detail and accuracy. 
                    Your task is to extract specific data points ('Class', 'Subject', 'Teacher-in-charge', 'No. of pages of original copy', 'No. of copies', 'Total No. of printed pages', 'Ricoh', and 'Toshiba') from the provided handwritten image. 
                    
                    1. Carefully examine the Handwritten Image.
                    2. Extract the value for each identified data point.
                    3. **Special Rule for Printers:** If the word 'Ricoh' or 'Toshiba' is CIRCLED, set its value to 1. If a specific number is written next to them, use that number.
                    4. Output the result STRICTLY as a JSON object. Do not include markdown formatting like \`\`\`json.
                    
                    The JSON must have these exact keys:
                    {
                        "date": "YYYY-MM-DD (if visible, else today)",
                        "class": "string",
                        "subject": "string",
                        "teacher": "string",
                        "originals": number,
                        "copies": number,
                        "total": number,
                        "ricoh": number,
                        "toshiba": number
                    }
                `;

                // Helper to make requests with retry on 429
                const makeRequest = async (retryCount = 0) => {
                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${this.apiKey}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                contents: [{
                                    parts: [
                                        { text: promptText },
                                        { inlineData: { mimeType: mimeType, data: base64Data } }
                                    ]
                                }],
                                generationConfig: {
                                    responseMimeType: "application/json"
                                }
                            })
                        });

                        // Handle Rate Limit (429) with Exponential Backoff
                        if (response.status === 429) {
                            if (retryCount < 5) {
                                const delay = Math.pow(2, retryCount) * 1000 + (Math.random() * 1000);
                                console.warn(`429 Too Many Requests. Retrying in ${Math.round(delay)}ms...`);
                                this.dom.ocrRaw.value = `Rate limit hit. Retrying in ${Math.ceil(delay/1000)}s...`;
                                await new Promise(resolve => setTimeout(resolve, delay));
                                return makeRequest(retryCount + 1);
                            } else {
                                throw new Error("API Rate Limit Exceeded. Please wait a moment and try again.");
                            }
                        }

                        if (!response.ok) throw new Error(`API Error: ${response.status}`);

                        return await response.json();
                    } catch (error) {
                        throw error;
                    }
                };

                try {
                    const result = await makeRequest();
                    const extractedText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (extractedText) {
                        console.log("Extraction success");
                        this.dom.ocrRaw.value = extractedText;
                        const data = JSON.parse(extractedText);
                        this.populateFields(data);
                        
                        // Alert User with Yellow Background (Visual Feedback)
                        if (this.dom.extractionForm) {
                            this.dom.extractionForm.classList.remove('bg-white');
                            this.dom.extractionForm.classList.add('bg-yellow-100', 'border-yellow-400');
                        }
                        
                    } else {
                        throw new Error("No data extracted");
                    }

                } catch (error) {
                    console.error("Extraction Error:", error);
                    this.dom.ocrRaw.value = `Error: ${error.message}. Please verify API key or internet connection.`;
                } finally {
                    this.dom.progressContainer.classList.add('hidden');
                    this.toggleFields(false);
                }
            },

            populateFields(data) {
                if (data.date) this.dom.fieldDate.value = data.date;
                // Reset fields first to ensure clean slate if keys missing
                this.dom.fieldClass.value = data.class || '';
                this.dom.fieldSubject.value = data.subject || '';
                this.dom.fieldTeacher.value = data.teacher || '';
                this.dom.fieldOriginals.value = data.originals || '';
                this.dom.fieldCopies.value = data.copies || '';
                this.dom.fieldTotal.value = data.total || '';
                this.dom.fieldRicoh.value = data.ricoh || '';
                this.dom.fieldToshiba.value = data.toshiba || '';
                
                // Recalculate total just in case
                this.calcTotal();
            },

            calcTotal() {
                const orig = parseInt(this.dom.fieldOriginals.value) || 0;
                const copies = parseInt(this.dom.fieldCopies.value) || 0;
                // Only auto-calculate if total is empty or 0 to respect OCR'd total if present
                if (!this.dom.fieldTotal.value || this.dom.fieldTotal.value == 0) {
                     this.dom.fieldTotal.value = orig * copies;
                }
            },

            toggleFields(disabled) {
                const inputs = this.dom.reviewSection.querySelectorAll('input');
                inputs.forEach(input => input.disabled = disabled);
            },

            returnToUpload() {
                this.dom.uploadZone.classList.remove('hidden');
                this.dom.reviewSection.classList.add('hidden');
                this.dom.fileInput.value = '';
                this.resetForm();
                this.totalInBatch = 0;
                this.processedInBatch = 0;
            },

            resetForm() {
                this.dom.ocrRaw.value = '';
                this.dom.fieldClass.value = '';
                this.dom.fieldSubject.value = '';
                this.dom.fieldTeacher.value = '';
                this.dom.fieldOriginals.value = '';
                this.dom.fieldCopies.value = '';
                this.dom.fieldTotal.value = '';
                this.dom.fieldRicoh.value = '';
                this.dom.fieldToshiba.value = '';
                
                // Reset Color (Back to White)
                if (this.dom.extractionForm) {
                    this.dom.extractionForm.classList.add('bg-white');
                    this.dom.extractionForm.classList.remove('bg-yellow-100', 'border-yellow-400');
                }
            },

            skipCurrent() {
                 this.resetForm();
                 this.processNextInQueue();
            },

            addToSheet() {
                const teacher = this.dom.fieldTeacher.value.trim();
                if (!teacher && !this.dom.fieldClass.value) {
                    if(!confirm("Class and Teacher are empty. Add anyway?")) return;
                }

                const row = {
                    id: Date.now(),
                    date: this.dom.fieldDate.value,
                    class: this.dom.fieldClass.value || '-',
                    subject: this.dom.fieldSubject.value || '-',
                    teacher: teacher || '-',
                    originals: this.dom.fieldOriginals.value || 0,
                    copies: this.dom.fieldCopies.value || 0,
                    total: this.dom.fieldTotal.value || 0,
                    ricoh: this.dom.fieldRicoh.value || 0,
                    toshiba: this.dom.fieldToshiba.value || 0
                };

                this.data.push(row);
                this.renderTable();
                
                // Move to next
                this.resetForm();
                this.processNextInQueue();
            },

            deleteRow(id) {
                this.data = this.data.filter(item => item.id !== id);
                this.renderTable();
            },

            renderTable() {
                this.dom.tableBody.innerHTML = '';
                
                if (this.data.length === 0) {
                    this.dom.tableBody.appendChild(this.dom.emptyState);
                    this.dom.rowCount.innerText = "0 Rows";
                    return;
                }

                this.dom.rowCount.innerText = `${this.data.length} Row${this.data.length !== 1 ? 's' : ''}`;
                const sortedData = [...this.data].sort((a, b) => new Date(b.date) - new Date(a.date));

                sortedData.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-gray-50 group transition-colors border-b border-gray-100";
                    
                    tr.innerHTML = `
                        <td class="px-4 py-3 text-gray-600">${item.date}</td>
                        <td class="px-4 py-3 font-medium text-gray-900">${item.class}</td>
                        <td class="px-4 py-3 text-gray-600">${item.subject}</td>
                        <td class="px-4 py-3 text-gray-600">${item.teacher}</td>
                        <td class="px-4 py-3 text-right text-gray-600 font-mono">${item.originals}</td>
                        <td class="px-4 py-3 text-right text-gray-600 font-mono">${item.copies}</td>
                        <td class="px-4 py-3 text-right font-bold text-indigo-600 font-mono">${item.total}</td>
                        <td class="px-4 py-3 text-right text-gray-500 font-mono">${item.ricoh}</td>
                        <td class="px-4 py-3 text-right text-gray-500 font-mono">${item.toshiba}</td>
                        <td class="px-4 py-3 text-center sticky right-0 bg-white group-hover:bg-gray-50 shadow-[-10px_0_10px_-5px_rgba(0,0,0,0.05)]">
                            <button onclick="app.deleteRow(${item.id})" class="text-gray-400 hover:text-red-500 transition-colors p-1">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                        </td>
                    `;
                    this.dom.tableBody.appendChild(tr);
                });
            },

            exportCSV() {
                if (this.data.length === 0) {
                    alert("No data to export.");
                    return;
                }
                let csv = "Date,Class,Subject,Teacher,Originals,Copies,Total Pages,Ricoh,Toshiba\n";
                this.data.forEach(row => {
                    csv += `${row.date},"${row.class}","${row.subject}","${row.teacher}",${row.originals},${row.copies},${row.total},${row.ricoh},${row.toshiba}\n`;
                });

                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                link.download = `printing_log_${new Date().toISOString().slice(0,10)}.csv`;
                link.click();
            }
        };

        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>

