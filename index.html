<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Printing Log Scanner</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .drag-active {
            border-color: #4f46e5;
            background-color: #eef2ff;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #c7c7c7; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1; 
        }
        
        /* Table cell padding fix */
        td, th {
            white-space: nowrap;
        }

        /* Resizer Styles */
        .resizer {
            width: 6px;
            background-color: #e5e7eb;
            cursor: col-resize;
            transition: background-color 0.2s;
            z-index: 30;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .resizer:hover, .resizer.resizing {
            background-color: #6366f1; /* Indigo-500 */
        }
        /* Handle icon visual */
        .resizer::after {
            content: "";
            height: 20px;
            width: 2px;
            background-color: #9ca3af;
            border-radius: 1px;
        }
        .resizer:hover::after, .resizer.resizing::after {
            background-color: white;
        }

        /* Validation Error State */
        .input-error {
            border-color: #ef4444 !important; /* Red-500 */
            background-color: #fef2f2 !important; /* Red-50 */
        }
    </style>
</head>
<body class="text-gray-800 h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 shadow-sm z-10 flex-shrink-0">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 text-white p-2 rounded-lg">
                    <i class="fa-solid fa-print"></i>
                </div>
                <h1 class="text-xl font-bold text-gray-900 tracking-tight">Printing<span class="text-indigo-600">Log</span>Scanner <span class="text-xs bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded ml-2">AI Powered</span></h1>
            </div>
            <div class="flex gap-2">
                <button onclick="app.exportCSV()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors flex items-center gap-2 shadow-sm">
                    <i class="fa-solid fa-file-csv"></i> Export Log
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex overflow-hidden relative" id="main-container">
        
        <!-- LEFT PANEL: Image / Upload Area -->
        <div class="flex-1 flex flex-col bg-gray-100 relative overflow-hidden" id="left-panel">
            
            <!-- Upload Section (Centered) -->
            <div id="upload-container" class="flex-1 flex flex-col items-center justify-center p-8">
                <div id="upload-zone" class="w-full max-w-lg border-2 border-dashed border-gray-300 rounded-xl p-12 text-center cursor-pointer transition-all duration-200 hover:border-indigo-400 hover:bg-white mb-6 group bg-gray-50">
                    <input type="file" id="file-input" class="hidden" accept="image/*" multiple>
                    <div class="flex flex-col items-center justify-center gap-4">
                        <div class="w-20 h-20 bg-indigo-50 text-indigo-600 rounded-full flex items-center justify-center text-3xl group-hover:scale-110 transition-transform">
                            <i class="fa-solid fa-cloud-arrow-up"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-900">Upload Log Images</h3>
                        <p class="text-gray-500">Drag & drop multiple files here to batch process.</p>
                    </div>
                </div>
            </div>

            <!-- Image Preview Section (Full Height) -->
            <div id="image-container" class="hidden flex-1 relative bg-gray-900 flex items-start justify-center p-4">
                <img id="preview-image" src="" alt="Preview" class="max-w-full max-h-full object-contain shadow-lg">
                
                <!-- Queue Count Overlay -->
                <div id="queue-badge" class="absolute top-4 left-4 bg-black/75 text-white text-sm font-medium px-3 py-1.5 rounded-full backdrop-blur-sm hidden border border-white/20">
                    Queue: 0
                </div>

                <div class="absolute top-4 right-4 opacity-0 hover:opacity-100 transition-opacity z-10">
                    <button onclick="app.skipCurrent()" class="bg-white/90 hover:bg-white text-red-600 px-4 py-2 rounded-lg shadow-lg font-medium flex items-center gap-2 backdrop-blur" title="Skip this image">
                        <i class="fa-solid fa-forward"></i> Skip Image
                    </button>
                </div>
            </div>

        </div>

        <!-- RESIZER HANDLER -->
        <div class="resizer" id="drag-handle"></div>

        <!-- RIGHT PANEL: Form & Data -->
        <div id="right-panel" class="flex flex-col bg-white shadow-xl z-20 h-full" style="width: 480px; min-width: 350px;">
            
            <!-- TOP: Extraction Form -->
            <div id="form-panel" class="hidden border-b border-gray-200 bg-white flex-shrink-0 max-h-[70vh] overflow-y-auto relative">
                 <!-- Progress Bar -->
                <div id="progress-container" class="px-6 pt-4 hidden">
                    <div class="flex justify-between mb-1">
                        <span class="text-xs font-medium text-indigo-600" id="progress-status">Scanning...</span>
                        <span class="text-xs font-medium text-indigo-600" id="progress-percent"></span>
                    </div>
                    <div class="w-full bg-gray-100 rounded-full h-1.5 overflow-hidden">
                        <div id="progress-bar" class="bg-indigo-600 h-1.5 rounded-full transition-all duration-1000 w-full animate-pulse"></div>
                    </div>
                </div>

                <div id="extraction-form" class="p-6 transition-colors duration-300">
                    <div class="flex items-center justify-between border-b pb-3 border-gray-200 mb-4">
                        <h3 class="font-semibold text-gray-800" id="form-title">Log Entry Details</h3>
                        <span class="text-xs bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full">AI Extraction</span>
                    </div>

                    <!-- Hidden Debug Field -->
                    <div class="mb-2 hidden">
                        <textarea id="field-ocr-raw" class="w-full h-20" readonly></textarea>
                    </div>

                    <!-- Form Fields -->
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Date</label>
                                <input type="date" id="field-date" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-colors">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Class</label>
                                <input type="text" id="field-class" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-colors" placeholder="e.g. 5A">
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div class="col-span-2">
                                <label class="block text-xs font-medium text-gray-700 mb-1">Subject</label>
                                <input type="text" id="field-subject" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-colors" placeholder="e.g. Mathematics">
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Teacher-in-charge</label>
                            <input type="text" id="field-teacher" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-colors" placeholder="Teacher Name">
                        </div>

                        <div class="grid grid-cols-3 gap-3 bg-gray-50 p-3 rounded-lg border border-gray-200">
                            <div>
                                <label class="block text-[10px] font-bold text-gray-500 mb-1 uppercase">Orig.</label>
                                <input type="number" id="field-originals" min="1" class="w-full border border-gray-300 rounded-md px-2 py-1.5 text-sm transition-colors" oninput="app.calcTotal()">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-gray-500 mb-1 uppercase">Copies</label>
                                <input type="number" id="field-copies" min="1" class="w-full border border-gray-300 rounded-md px-2 py-1.5 text-sm transition-colors" oninput="app.calcTotal()">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-gray-500 mb-1 uppercase">Total</label>
                                <input type="number" id="field-total" readonly class="w-full border border-gray-200 bg-gray-100 rounded-md px-2 py-1.5 text-sm font-bold text-indigo-600">
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Ricoh</label>
                                <input type="number" id="field-ricoh" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition-colors" placeholder="0">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Toshiba</label>
                                <input type="number" id="field-toshiba" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition-colors" placeholder="0">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Remarks</label>
                            <input type="text" id="field-remarks" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-colors" placeholder="Optional notes...">
                        </div>

                        <button onclick="app.addToSheet()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-lg font-medium shadow-md hover:shadow-lg transition-all flex justify-center items-center gap-2 mt-2">
                            <i class="fa-solid fa-plus-circle"></i> <span id="btn-add-text">Add Entry</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- BOTTOM: Data Table -->
            <div class="flex-1 flex flex-col overflow-hidden bg-gray-50 border-t border-gray-200 relative">
                <div class="p-3 bg-white border-b border-gray-200 flex justify-between items-center shadow-sm z-10">
                    <h2 class="font-semibold text-gray-700 flex items-center gap-2 text-sm">
                        <i class="fa-solid fa-table text-gray-400"></i> Printing Log Data
                    </h2>
                    <span id="row-count" class="text-[10px] font-medium bg-gray-100 text-gray-600 px-2 py-1 rounded border border-gray-200">0 Rows</span>
                </div>

                <div class="flex-1 overflow-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-50 text-[11px] uppercase text-gray-500 font-semibold sticky top-0 z-10 shadow-sm">
                            <tr>
                                <th class="px-3 py-2 border-b bg-gray-50">Date</th>
                                <th class="px-3 py-2 border-b bg-gray-50">Class</th>
                                <th class="px-3 py-2 border-b bg-gray-50">Subject</th>
                                <th class="px-3 py-2 border-b bg-gray-50">Teacher</th>
                                <th class="px-3 py-2 border-b bg-gray-50 text-right">Total</th>
                                <th class="px-3 py-2 border-b bg-gray-50">Remarks</th>
                                <th class="px-3 py-2 border-b bg-gray-50 text-center">Act</th>
                            </tr>
                        </thead>
                        <tbody id="data-table-body" class="text-sm divide-y divide-gray-100 bg-white">
                            <tr id="empty-state">
                                <td colspan="7" class="px-4 py-12 text-center text-gray-400 italic text-sm">
                                    <div class="flex flex-col items-center gap-2">
                                        <i class="fa-solid fa-print text-2xl mb-1 text-gray-300"></i>
                                        Waiting for data...
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>

    </main>

    <!-- Scripts -->
    <script>
        const app = {
            data: [],
            // TODO: PASTE YOUR API KEY HERE FOR DEPLOYMENT
            apiKey: "AIzaSyC4iwYQrbtDTUumIXf7v3UVeTfp4cpJuJU", 
            
            // Queue Management
            queue: [],
            totalInBatch: 0,
            processedInBatch: 0,
            
            // Resizer State
            isResizing: false,

            init() {
                console.log("App initialized");
                this.cacheDOM();
                this.bindEvents();
                this.dom.fieldDate.valueAsDate = new Date();
            },

            cacheDOM() {
                this.dom = {
                    mainContainer: document.getElementById('main-container'),
                    dragHandle: document.getElementById('drag-handle'),
                    rightPanel: document.getElementById('right-panel'),
                    
                    uploadContainer: document.getElementById('upload-container'),
                    uploadZone: document.getElementById('upload-zone'),
                    fileInput: document.getElementById('file-input'),
                    
                    imageContainer: document.getElementById('image-container'),
                    previewImage: document.getElementById('preview-image'),
                    queueBadge: document.getElementById('queue-badge'),
                    
                    formPanel: document.getElementById('form-panel'),
                    extractionForm: document.getElementById('extraction-form'),
                    formTitle: document.getElementById('form-title'),
                    
                    progressContainer: document.getElementById('progress-container'),
                    progressBar: document.getElementById('progress-bar'),
                    progressStatus: document.getElementById('progress-status'),
                    btnAddText: document.getElementById('btn-add-text'),
                    
                    // Inputs
                    ocrRaw: document.getElementById('field-ocr-raw'),
                    fieldDate: document.getElementById('field-date'),
                    fieldClass: document.getElementById('field-class'),
                    fieldSubject: document.getElementById('field-subject'),
                    fieldTeacher: document.getElementById('field-teacher'),
                    fieldOriginals: document.getElementById('field-originals'),
                    fieldCopies: document.getElementById('field-copies'),
                    fieldTotal: document.getElementById('field-total'),
                    fieldRicoh: document.getElementById('field-ricoh'),
                    fieldToshiba: document.getElementById('field-toshiba'),
                    fieldRemarks: document.getElementById('field-remarks'),
                    
                    tableBody: document.getElementById('data-table-body'),
                    rowCount: document.getElementById('row-count'),
                    emptyState: document.getElementById('empty-state')
                };
            },

            bindEvents() {
                // Drag & Drop Upload
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    this.dom.uploadZone.addEventListener(eventName, this.preventDefaults, false);
                });
                ['dragenter', 'dragover'].forEach(eventName => this.dom.uploadZone.classList.add('drag-active'));
                ['dragleave', 'drop'].forEach(eventName => this.dom.uploadZone.classList.remove('drag-active'));

                this.dom.uploadZone.addEventListener('drop', this.handleDrop.bind(this), false);
                this.dom.uploadZone.addEventListener('click', () => this.dom.fileInput.click());
                this.dom.fileInput.addEventListener('change', this.handleFileSelect.bind(this));

                // Resizer Events
                this.dom.dragHandle.addEventListener('mousedown', (e) => {
                    this.isResizing = true;
                    this.dom.dragHandle.classList.add('resizing');
                    document.body.style.cursor = 'col-resize';
                    e.preventDefault(); // Prevent selection
                });

                document.addEventListener('mousemove', (e) => {
                    if (!this.isResizing) return;
                    const containerWidth = this.dom.mainContainer.offsetWidth;
                    const newRightWidth = containerWidth - e.clientX;
                    
                    // Constraints: Min 300px, Max 70% of screen
                    if (newRightWidth > 300 && newRightWidth < containerWidth * 0.7) {
                        this.dom.rightPanel.style.width = `${newRightWidth}px`;
                    }
                });

                document.addEventListener('mouseup', () => {
                    if (this.isResizing) {
                        this.isResizing = false;
                        this.dom.dragHandle.classList.remove('resizing');
                        document.body.style.cursor = 'default';
                    }
                });
                
                // Input Listeners for clearing Error state on type
                const inputs = this.dom.extractionForm.querySelectorAll('input');
                inputs.forEach(input => {
                    input.addEventListener('input', () => {
                        if (input.classList.contains('input-error')) {
                            input.classList.remove('input-error');
                        }
                        if(input.id === 'field-originals' || input.id === 'field-copies') {
                            this.calcTotal();
                        }
                    });
                });
            },

            preventDefaults(e) { e.preventDefault(); e.stopPropagation(); },

            handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                this.handleFiles(files);
            },

            handleFileSelect(e) {
                const files = e.target.files;
                this.handleFiles(files);
            },

            handleFiles(files) {
                const imageFiles = Array.from(files).filter(file => file.type.startsWith('image/'));
                
                if (imageFiles.length > 0) {
                    this.queue.push(...imageFiles);
                    
                    // Check if we need to start processing
                    if (this.dom.imageContainer.classList.contains('hidden')) {
                        this.totalInBatch = this.queue.length;
                        this.processedInBatch = 0;
                        this.processNextInQueue();
                    } else {
                        // Adding to existing batch
                        this.totalInBatch += imageFiles.length;
                        this.updateQueueUI();
                    }
                } else {
                    alert("Please upload image files.");
                }
            },

            processNextInQueue() {
                if (this.queue.length === 0) {
                    this.returnToUpload();
                    return;
                }

                const file = this.queue.shift();
                this.processedInBatch++;
                this.updateQueueUI();
                this.previewAndProcess(file);
            },

            updateQueueUI() {
                const remaining = this.queue.length;
                if (remaining > 0) {
                    this.dom.queueBadge.innerText = `Queue: ${remaining}`;
                    this.dom.queueBadge.classList.remove('hidden');
                    this.dom.btnAddText.innerText = "Add & Next";
                } else {
                    this.dom.queueBadge.classList.add('hidden');
                    this.dom.btnAddText.innerText = "Add Entry";
                }
                this.dom.formTitle.innerText = `Entry ${this.processedInBatch} / ${this.totalInBatch}`;
            },

            previewAndProcess(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    // 1. Load original image to get dimensions
                    const img = new Image();
                    img.onload = () => {
                        // 2. Optimization Logic
                        // Resize larger images to max 1024px width to speed up upload & OCR
                        const MAX_WIDTH = 1024;
                        let width = img.width;
                        let height = img.height;

                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }

                        // Draw to canvas
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        // 3. Export as compressed JPEG (0.7 quality)
                        const optimizedBase64 = canvas.toDataURL('image/jpeg', 0.7).split(',')[1];

                        // 4. Update UI
                        this.dom.previewImage.src = e.target.result; // Show original or optimized
                        
                        this.dom.uploadContainer.classList.add('hidden');
                        this.dom.imageContainer.classList.remove('hidden');
                        this.dom.formPanel.classList.remove('hidden');

                        // 5. Send optimized data
                        this.processImageWithGemini(optimizedBase64, 'image/jpeg');
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            },

            async processImageWithGemini(base64Data, mimeType) {
                if(!this.apiKey) {
                     const userKey = prompt("Please enter your Google Gemini API Key:");
                     if(userKey && userKey.trim() !== "") {
                         this.apiKey = userKey.trim();
                     } else {
                         alert("API Key required. Returning to upload.");
                         this.returnToUpload();
                         return;
                     }
                }

                this.dom.progressContainer.classList.remove('hidden');
                this.dom.progressStatus.innerText = `Scanning image...`;
                this.toggleFields(true);
                this.resetValidation(); // Clear previous errors
                
                // Reset background color
                this.dom.extractionForm.classList.add('bg-white');
                this.dom.extractionForm.classList.remove('bg-yellow-100');

                const promptText = `
                    Extract data from handwritten log. JSON only.
                    Keys: date (YYYY-MM-DD), class, subject, teacher, originals (number), copies (number), total (number), ricoh (number), toshiba (number), remarks (string).
                    Special Rule: If 'Ricoh' or 'Toshiba' is CIRCLED, value is 1. If number written, use number. Get the handwritten text for remarks if present.
                `;

                const makeRequest = async (retryCount = 0) => {
                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${this.apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{
                                    parts: [
                                        { text: promptText },
                                        { inlineData: { mimeType: mimeType, data: base64Data } }
                                    ]
                                }],
                                generationConfig: { responseMimeType: "application/json" }
                            })
                        });

                        if (response.status === 429 && retryCount < 3) {
                            await new Promise(r => setTimeout(r, 2000 * (retryCount + 1)));
                            return makeRequest(retryCount + 1);
                        }

                        if (!response.ok) throw new Error(`API Error: ${response.status}`);
                        return await response.json();
                    } catch (error) { throw error; }
                };

                try {
                    const result = await makeRequest();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (text) {
                        this.populateFields(JSON.parse(text));
                        // Visual Success
                        this.dom.extractionForm.classList.remove('bg-white');
                        this.dom.extractionForm.classList.add('bg-yellow-100');
                    } else {
                        throw new Error("No text extracted");
                    }
                } catch (error) {
                    console.error(error);
                    alert(`Extraction Failed: ${error.message}`);
                } finally {
                    this.dom.progressContainer.classList.add('hidden');
                    this.toggleFields(false);
                }
            },

            populateFields(data) {
                this.setAndValidate('field-date', data.date);
                this.setAndValidate('field-class', data.class);
                this.setAndValidate('field-subject', data.subject);
                this.setAndValidate('field-teacher', data.teacher);
                this.setAndValidate('field-originals', data.originals);
                this.setAndValidate('field-copies', data.copies);
                this.setAndValidate('field-ricoh', data.ricoh);
                this.setAndValidate('field-toshiba', data.toshiba);
                // Remarks is optional so we don't enforce red error if missing, but we set it if present
                const remarksEl = document.getElementById('field-remarks');
                if(remarksEl) remarksEl.value = data.remarks || '';
                
                // Total is calculated, not directly extracted usually, but if present:
                if (data.total) this.dom.fieldTotal.value = data.total;
                this.calcTotal();
            },

            setAndValidate(elementId, value) {
                const el = document.getElementById(elementId);
                if (!el) return;

                // Check if value is "empty"
                const isEmpty = value === null || value === undefined || value === '';
                
                if (isEmpty) {
                    el.value = '';
                    el.classList.add('input-error');
                } else {
                    el.value = value;
                    el.classList.remove('input-error');
                }
            },
            
            resetValidation() {
                const inputs = this.dom.extractionForm.querySelectorAll('input');
                inputs.forEach(input => input.classList.remove('input-error'));
            },

            calcTotal() {
                const orig = parseInt(this.dom.fieldOriginals.value) || 0;
                const copies = parseInt(this.dom.fieldCopies.value) || 0;
                if (!this.dom.fieldTotal.value || this.dom.fieldTotal.value == 0) {
                     this.dom.fieldTotal.value = orig * copies;
                }
            },

            toggleFields(disabled) {
                const inputs = this.dom.extractionForm.querySelectorAll('input');
                inputs.forEach(input => input.disabled = disabled);
            },

            returnToUpload() {
                this.dom.uploadContainer.classList.remove('hidden');
                this.dom.imageContainer.classList.add('hidden');
                this.dom.formPanel.classList.add('hidden');
                
                this.resetForm();
                this.totalInBatch = 0;
                this.processedInBatch = 0;
            },

            resetForm() {
                this.dom.fieldClass.value = '';
                this.dom.fieldSubject.value = '';
                this.dom.fieldTeacher.value = '';
                this.dom.fieldOriginals.value = '';
                this.dom.fieldCopies.value = '';
                this.dom.fieldTotal.value = '';
                this.dom.fieldRicoh.value = '';
                this.dom.fieldToshiba.value = '';
                this.dom.fieldRemarks.value = '';
                this.dom.extractionForm.classList.add('bg-white');
                this.dom.extractionForm.classList.remove('bg-yellow-100');
                this.resetValidation();
            },

            skipCurrent() {
                 this.resetForm();
                 this.processNextInQueue();
            },

            addToSheet() {
                if (!this.dom.fieldTeacher.value && !this.dom.fieldClass.value) {
                    if(!confirm("Empty fields. Add anyway?")) return;
                }

                const row = {
                    id: Date.now(),
                    date: this.dom.fieldDate.value,
                    class: this.dom.fieldClass.value || '-',
                    subject: this.dom.fieldSubject.value || '-',
                    teacher: this.dom.fieldTeacher.value || '-',
                    total: this.dom.fieldTotal.value || 0,
                    ricoh: this.dom.fieldRicoh.value || 0,
                    toshiba: this.dom.fieldToshiba.value || 0,
                    remarks: this.dom.fieldRemarks.value || ''
                };

                this.data.push(row);
                this.renderTable();
                
                this.resetForm();
                this.processNextInQueue();
            },

            deleteRow(id) {
                this.data = this.data.filter(item => item.id !== id);
                this.renderTable();
            },

            renderTable() {
                this.dom.tableBody.innerHTML = '';
                
                if (this.data.length === 0) {
                    this.dom.tableBody.appendChild(this.dom.emptyState);
                    this.dom.rowCount.innerText = "0 Rows";
                    return;
                }

                this.dom.rowCount.innerText = `${this.data.length} Row${this.data.length !== 1 ? 's' : ''}`;
                const sortedData = [...this.data].sort((a, b) => new Date(b.date) - new Date(a.date));

                sortedData.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-gray-50 group transition-colors border-b border-gray-100";
                    
                    tr.innerHTML = `
                        <td class="px-3 py-2 text-gray-600">${item.date}</td>
                        <td class="px-3 py-2 font-medium text-gray-900">${item.class}</td>
                        <td class="px-3 py-2 text-gray-600 truncate max-w-[100px]">${item.subject}</td>
                        <td class="px-3 py-2 text-gray-600 truncate max-w-[100px]">${item.teacher}</td>
                        <td class="px-3 py-2 text-right font-bold text-indigo-600 font-mono">${item.total}</td>
                        <td class="px-3 py-2 text-gray-600 truncate max-w-[100px]">${item.remarks}</td>
                        <td class="px-3 py-2 text-center">
                            <button onclick="app.deleteRow(${item.id})" class="text-gray-300 hover:text-red-500 transition-colors">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                        </td>
                    `;
                    this.dom.tableBody.appendChild(tr);
                });
            },

            exportCSV() {
                if (this.data.length === 0) return alert("No data.");
                let csv = "Date,Class,Subject,Teacher,Total Pages,Ricoh,Toshiba,Remarks\n";
                this.data.forEach(r => {
                    csv += `${r.date},"${r.class}","${r.subject}","${r.teacher}",${r.total},${r.ricoh},${r.toshiba},"${r.remarks}"\n`;
                });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
                link.download = `log_${new Date().toISOString().slice(0,10)}.csv`;
                link.click();
            }
        };

        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
